# 安装
1. 安装containerd
```bash
# 配置阿里云docker-ce源
wget -O /etc/yum.repos.d/docker-ce.repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
# 安装containerd
yum install -y containerd.io
# 设置开机自启
systemctl enable containerd

# 导出默认配置覆盖/etc/containerd/config.toml
containerd config default > /etc/containerd/config.toml

# 修改配置registry.k8s.io为registry.aliyuncs.com/google_containers
sed -i 's#registry.k8s.io#registry.aliyuncs.com/google_containers#g' /etc/containerd/config.toml

# 启动containerd
systemctl start containerd
```
2. 安装k8s工具：kubelet、kubeadm、kubectl
```bash
cat <<EOF > /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/
enabled=1
gpgcheck=1
repo_gpgcheck=1
gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
EOF
yum install -y kubelet kubeadm kubectl
systemctl enable kubelet
```
3. 系统配置
```bash
# 关闭防火墙
systemctl stop firewalld && systemctl disable firewalld && iptables -F 
# 关闭selinux
sed -i 's/enforcing/disabled/' /etc/selinux/config && setenforce 0  

# 关闭swap
swapoff -a  # 临时关闭
sed -ri 's/.*swap.*/#&/' /etc/fstab  #永久关闭

# 根据角色修改主机名，以k8s-master为例
hostnamectl set-hostname k8s-master # 永久修改

# 加载br_netfilter模块
cat >> /etc/modules-load.d/k8s.conf << EOF
br_netfilter
EOF
systemctl restart systemd-modules-load.service

# 修改内核参数
cat > /etc/sysctl.d/k8s.conf << EOF
net.bridge.bridge-nf-call-iptables=1
net.bridge.bridge-nf-call-ip6tables=1
net.ipv4.ip_forward=1
EOF
# sysctl -p # 重新加载所有参数
sysctl -p /etc/sysctl.d/k8s.conf 重新加载指定文件内的参数
sysctl --system # 查看内核参数
```

# 集群管理
1. k8s: 1.28.2
2. containerd: 1.6.33
3. os: centos 7
```txt
192.168.74.250 k8s-master
192.168.74.251 k8s-node1
192.168.74.252 k8s-node2
192.168.74.253 k8s-node3
```
所有主机都执行[安装](#安装)

## 集群初始化
1. **检查**containerd和k8s所依赖的`pause`镜像是否一致：镜像名+tag
   1. containerd 配置中 `[plugins."io.containerd.grpc.v1.cri"]`配置下`sandbox_image`
   2. k8s检查配置：`kubeadm config images list`
   3. 若不一致则修改为一致：以`registry.aliyuncs.com/google_containers/pause:3.9`为例
2. 在**master节点执行**初始化
```bash
kubeadm init --apiserver-advertise-address=192.168.74.250 --image-repository registry.aliyuncs.com/google_containers
```
* 执行成功后，会输出如下信息
```txt
Your Kubernetes control-plane has initialized successfully!

To start using your cluster, you need to run the following as a regular user:

mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config

Alternatively, if you are the root user, you can run:

export KUBECONFIG=/etc/kubernetes/admin.conf

You should now deploy a pod network to the cluster.
Run "kubectl apply -f [podnetwork].yaml" with one of the options listed at:
https://kubernetes.io/docs/concepts/cluster-administration/addons/

Then you can join any number of worker nodes by running the following on each as root:

kubeadm join 192.168.74.250:6443 --token 1ozaan.m0id4vj2zhmka1vv \
        --discovery-token-ca-cert-hash sha256:359163ceb1d2a9e8e0d5c2142c9a06171d634982f32c74a029a2d15ff1c64363
```
* 后续操作
```bash
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config

export KUBECONFIG=/etc/kubernetes/admin.conf
```
## 网路插件(必需)
* Flannel
```bash
wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
kubectl apply -f kube-flannel.yml
```
## token管理
在**控制节点操作**，默认初始化的token只有24小时有效期，过期可重新生成
* 查看当前token列表:
```bash
TOKEN                     TTL         EXPIRES                USAGES                   DESCRIPTION                                                EXTRA GROUPS
hk80j0.m0id4vj2zhmka1vv   23h         2025-01-08T04:16:36Z   authentication,signing   The default bootstrap token generated by 'kubeadm init'.   system:bootstrappers:kubeadm:default-node-token
```
* 创建新token:`kubeadm token create`
  * `--print-join-command`：参数可输出完整新节点加入命令

## 部署dashboard
1. 下载dashboard配置
```bash
wget https://raw.githubusercontent.com/kubernetes/dashboard/v2.5.0/aio/deploy/recommended.yaml
```
2. 执行部署
   1. 修改service指定类型为`NodePort`，默认为`ClusterIP`
    ```bash
    vi recommended.yaml

    kind: Service
    apiVersion: v1
    metadata:
        labels:
            k8s-app: kubernetes-dashboard
        name: kubernetes-dashboard
        namespace: kubernetes-dashboard
    spec:
        type: NodePort # 类型为NodePort，默认为`ClusterIP`
        ports:
          - port: 443
            targetPort: 8443
            nodePort: 30001 # 映射主机端口
    selector:
        k8s-app: kubernetes-dashboard
    ```
    2. 执行Pod
    ```bash
    kubectl apply -f recommended.yaml
    ```
3. 查看服务状态
   1. 若非`Running`状态，建议通过`kubectl describe pod`命令查看详情
    ```bash
    # 查看Pod状态: running 为成功启动状态
    kubectl get pods --all-namespaces

    # 查看dashboard服务：可查看实际映射端口
    kubectl get svc -n kubernetes-dashboard
    ```
4. 登陆系统
   * 创建登陆Token，权限很低，临时性
    ```bash
    kubectl -n kubernetes-dashboard create token kubernetes-dashboard
    ```
   * 创建`service account`访问用户(管理员)
    ```bash
    # 创建用户
    kubectl create serviceaccount dashboard-admin -n kube-system
    # 授予用户权限
    kubectl create clusterrolebinding dashboard-admin --clusterrole=cluster-admin --serviceaccount=kubernetes-dashboard:dashboard-admin
    # 获取token
    kubectl create token dashboard-admin -n kubernetes-dashboard
    ```

## 节点加入
在**新节点操作**，将节点注册到`kubeadm`中，需要从控制节点获取`token`和`hash`
* 所有准备加入集群的从节点
```bash
kubeadm join 192.168.74.250:6443 --token 1ozaan.m0id4vj2zhmka1vv \
        --discovery-token-ca-cert-hash sha256:359163ceb1d2a9e8e0d5c2142c9a06171d634982f32c74a029a2d15ff1c64363
```
## 节点删除
在**控制节点操作**，删除节点前需要先从集群中移除节点
* 查看集群节点
```bash
kubectl get nodes
```
* 移除节点
```bash
kubectl delete node <node-name>
```
在**从节点操作**，执行以下命令
```bash
kubeadm reset
```
